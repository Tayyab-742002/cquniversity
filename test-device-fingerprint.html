<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FingerprintJS Device Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@4/dist/fp.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .component {
            margin: 10px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-left: 4px solid #007bff;
            border-radius: 4px;
        }
        .component-title {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }
        .component-value {
            font-family: monospace;
            color: #666;
            word-break: break-all;
        }
        .confidence-bar {
            width: 100%;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .confidence-fill {
            height: 100%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .device-id {
            font-size: 18px;
            font-weight: bold;
            color: #28a745;
            text-align: center;
            padding: 20px;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            margin: 20px 0;
        }
        .visitor-id {
            font-size: 14px;
            font-family: monospace;
            color: #6c757d;
            text-align: center;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            margin: 10px 0;
            word-break: break-all;
        }
        .lab-computer {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat {
            text-align: center;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
        .refresh-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 20px auto;
            display: block;
        }
        .refresh-btn:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê FingerprintJS Device Test</h1>
        <p>This page tests the FingerprintJS device fingerprinting implementation used in the PsycoTest platform.</p>
        
        <div style="background: #e8f5e8; padding: 15px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #4caf50;">
            <strong>üñ•Ô∏è Screen-Independent Fingerprinting:</strong> This system automatically excludes all screen-related factors (resolution, color depth, multiple monitors) to ensure the same device generates the same ID regardless of screen configuration. A user with 4 monitors cannot create 4 accounts!
        </div>
        
        <button class="refresh-btn" onclick="generateFingerprint()">üîÑ Generate New Fingerprint</button>
        
        <div id="loading" class="loading">
            <div>üîç Generating device fingerprint with FingerprintJS...</div>
            <div style="margin-top: 10px; font-size: 14px;">This may take a few seconds...</div>
        </div>
        
        <div id="results" style="display: none;">
            <div id="device-id" class="device-id"></div>
            <div id="visitor-id" class="visitor-id"></div>
            <div id="lab-computer" class="lab-computer" style="display: none;"></div>
            
            <h3>üìä Confidence Score</h3>
            <div class="confidence-bar">
                <div id="confidence-fill" class="confidence-fill"></div>
            </div>
            
            <div class="stats">
                <div class="stat">
                    <div id="components-count" class="stat-value">-</div>
                    <div class="stat-label">Stable/Total Components</div>
                </div>
                <div class="stat">
                    <div id="library-version" class="stat-value">-</div>
                    <div class="stat-label">Library</div>
                </div>
                <div class="stat">
                    <div id="generation-time" class="stat-value">-</div>
                    <div class="stat-label">Generation Time (ms)</div>
                </div>
                <div class="stat">
                    <div id="platform-info" class="stat-value">-</div>
                    <div class="stat-label">Platform</div>
                </div>
            </div>
            
            <h3>üîß Fingerprint Components</h3>
            <div id="components"></div>
            
            <h3>üìã Raw Data (JSON)</h3>
            <div class="component">
                <pre id="raw-data" style="overflow-x: auto; font-size: 12px;"></pre>
            </div>
        </div>
    </div>

    <script>
        let fpPromise = null;

        // Initialize FingerprintJS
        async function getFingerprintAgent() {
            if (!fpPromise) {
                fpPromise = FingerprintJS.load();
            }
            return fpPromise;
        }

        // Simple hash function (matching the one in deviceFingerprint.js)
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32-bit integer
            }
            return Math.abs(hash).toString(36);
        }

        // Filter out screen-dependent components
        function getStableComponents(components) {
            const screenDependentComponents = [
                'screenResolution',
                'screenFrame', 
                'colorDepth',
                'colorGamut',
                'hdr',
                'screenRect',
                'availableScreenRect',
                'devicePixelRatio'
            ];
            
            const stableComponents = {};
            
            Object.entries(components).forEach(([key, component]) => {
                if (!screenDependentComponents.includes(key)) {
                    stableComponents[key] = component;
                }
            });
            
            console.log('üîß Filtered out screen-dependent components:', screenDependentComponents.filter(comp => components[comp]));
            console.log('‚úÖ Using stable components:', Object.keys(stableComponents));
            
            return stableComponents;
        }

        // Detect lab computer
        function detectLabComputer(components) {
            let labIndicators = 0;
            
            const platform = components.platform?.value || '';
            const hardwareConcurrency = components.hardwareConcurrency?.value || 0;
            const deviceMemory = components.deviceMemory?.value || 0;
            const plugins = components.plugins?.value || [];
            
            if (hardwareConcurrency >= 8) labIndicators++;
            if (deviceMemory >= 8) labIndicators++;
            if (plugins.length <= 3) labIndicators++;
            if (platform.includes('Win')) labIndicators++;
            
            return labIndicators >= 2;
        }

        // Calculate confidence (screen-independent)
        function calculateConfidence(stableComponents, isLabComputer) {
            let score = 0;
            let maxScore = 0;
            
            // Core components (higher weight) - excluding screen-dependent ones
            const coreComponents = ['canvas', 'webgl', 'audio', 'fonts', 'plugins'];
            coreComponents.forEach(component => {
                maxScore += 20;
                if (stableComponents[component] && stableComponents[component].value !== undefined) {
                    score += 20;
                }
            });
            
            // Hardware components (medium weight) - excluding screen resolution
            const hardwareComponents = ['platform', 'hardwareConcurrency', 'deviceMemory'];
            hardwareComponents.forEach(component => {
                maxScore += 15;
                if (stableComponents[component] && stableComponents[component].value !== undefined) {
                    score += 15;
                }
            });
            
            // Browser components (lower weight)
            const browserComponents = ['userAgent', 'language', 'cookiesEnabled', 'localStorage', 'timezone'];
            browserComponents.forEach(component => {
                maxScore += 5;
                if (stableComponents[component] && stableComponents[component].value !== undefined) {
                    score += 5;
                }
            });
            
            const baseConfidence = Math.round((score / maxScore) * 100);
            
            if (isLabComputer) {
                return Math.max(baseConfidence - 15, 60);
            }
            
            return Math.min(baseConfidence, 95);
        }

        // Generate fingerprint
        async function generateFingerprint() {
            const startTime = performance.now();
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            
            try {
                console.log('üîê Generating device fingerprint with FingerprintJS...');
                
                const fp = await getFingerprintAgent();
                const result = await fp.get({ extendedResult: true });
                
                // Filter out screen-dependent components for stable device ID
                const stableComponents = getStableComponents(result.components);
                
                // Create a stable visitor ID using only non-screen components
                const stableDataString = JSON.stringify(stableComponents, Object.keys(stableComponents).sort());
                const stableVisitorId = simpleHash(stableDataString);
                const deviceId = simpleHash(stableVisitorId);
                
                const isLabComputer = detectLabComputer(stableComponents);
                const confidence = calculateConfidence(stableComponents, isLabComputer);
                
                const endTime = performance.now();
                const generationTime = Math.round(endTime - startTime);
                
                // Display results
                displayResults({
                    visitorId: stableVisitorId,
                    deviceId,
                    components: stableComponents,
                    confidence,
                    isLabComputer,
                    generationTime,
                    componentsCount: Object.keys(stableComponents).length,
                    originalComponentsCount: Object.keys(result.components).length
                });
                
            } catch (error) {
                console.error('‚ùå FingerprintJS error:', error);
                document.getElementById('loading').innerHTML = `
                    <div style="color: red;">
                        ‚ùå Error generating fingerprint: ${error.message}
                    </div>
                `;
            }
        }

        // Display results
        function displayResults(data) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('results').style.display = 'block';
            
            // Device ID
            document.getElementById('device-id').textContent = `Device ID: ${data.deviceId}`;
            
            // Visitor ID
            document.getElementById('visitor-id').textContent = `Visitor ID: ${data.visitorId}`;
            
            // Lab computer detection
            if (data.isLabComputer) {
                const labElement = document.getElementById('lab-computer');
                labElement.style.display = 'block';
                labElement.textContent = 'üè´ Lab Computer Detected: This device appears to be a university/institutional computer';
            }
            
            // Confidence
            const confidenceFill = document.getElementById('confidence-fill');
            confidenceFill.style.width = `${data.confidence}%`;
            confidenceFill.textContent = `${data.confidence}%`;
            
            if (data.confidence >= 80) {
                confidenceFill.style.backgroundColor = '#28a745';
            } else if (data.confidence >= 60) {
                confidenceFill.style.backgroundColor = '#ffc107';
            } else {
                confidenceFill.style.backgroundColor = '#dc3545';
            }
            
            // Stats
            document.getElementById('components-count').textContent = `${data.componentsCount}/${data.originalComponentsCount}`;
            document.getElementById('library-version').textContent = 'FingerprintJS OSS';
            document.getElementById('generation-time').textContent = data.generationTime;
            document.getElementById('platform-info').textContent = data.components.platform?.value || 'Unknown';
            
            // Components
            displayComponents(data.components);
            
            // Raw data
            document.getElementById('raw-data').textContent = JSON.stringify({
                deviceId: data.deviceId,
                visitorId: data.visitorId,
                confidence: data.confidence,
                isLabComputer: data.isLabComputer,
                components: data.components
            }, null, 2);
        }

        // Display components
        function displayComponents(components) {
            const container = document.getElementById('components');
            container.innerHTML = '';
            
            Object.entries(components).forEach(([key, component]) => {
                const div = document.createElement('div');
                div.className = 'component';
                
                let value = component.value;
                if (typeof value === 'object') {
                    value = JSON.stringify(value);
                } else if (typeof value === 'string' && value.length > 100) {
                    value = value.substring(0, 100) + '...';
                }
                
                div.innerHTML = `
                    <div class="component-title">${key}</div>
                    <div class="component-value">${value}</div>
                `;
                
                container.appendChild(div);
            });
        }

        // Generate fingerprint on page load
        window.addEventListener('load', generateFingerprint);
    </script>
</body>
</html> 